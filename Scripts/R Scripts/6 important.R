library(DBI)
library(lattice)
library(Hmisc)
library(dplyr)
library(RMySQL)
library(DMwR)
library(unbalanced)
library(e1071)
library(MASS)
library(rpart)

con <- dbConnect(MySQL(), user = 'root', password = 'admin', host = 'localhost', dbname='changehistory')
#vetorPaths <- c("dom","javascript","javascript_extras","javascript_xpconnect","layout_rendering","libraries","kernel","network","webpage_structure","widget")
#for(i in vetorPaths){      
querryTable="mozillaClassify3"
querryBefore="SELECT  vulnerability, SUM(NCEC),SUM(NCMC),SUM(NFCEC),SUM(NFCMC),SUM(NMEC),SUM(NMMC),SUM(NVEC),SUM(NVMC) FROM "
querryAfter=" where typevulnerability='Bypass' GROUP BY cvecode;"
kernelclassify <- dbGetQuery(con,paste(querryBefore,querryTable,querryAfter,sep=""))


#kernel_vulnerabilities <- subset(kernelclassify,vulnerability == 1)

#kernel_without_vulnerabilities <- subset(kernelclassify,vulnerability == 0)

n<-ncol(kernelclassify)

#kernelclassify
output <- factor(ifelse(kernelclassify[1]==0,"non-vulnerable","vulnerable"))
output

input<-kernelclassify[,-1]

View(input)
table(output)
#View(output)
#newData <- SMOTE(vulnerability ~ ., kernelclassify, perc.over = 600,perc.under=100)
#table(newData)
#newData<-ubSMOTE(X= input, Y=output, perc.over = 200, k = 5, perc.under = 200, verbose = TRUE,)

newdb <- ubBalance(X=input, Y=output, type="ubSMOTE", positive="vulnerable", percOver=100, percUnder=600,
          k=5, perc=50, method="percPos", w=NULL, verbose=TRUE)

#table(newdb$Y)




#View(kernelclassify[1])
 
               

Species= as.factor(ifelse(newdb$Y=="non-vulnerable",FALSE,TRUE))


Species


## split data into a train and test set


output2 <- kernelclassify[,-1]

model.svm <- svm(Species ~ ., data = newdb$X)
svm.pred  <- predict(model.svm , output2)



table(svm.pred)

prediction = predict(model.svm,output2)
 rpart.model <- rpart(Species ~ ., data = newdb$X)
 rpart.pred  <- predict(rpart.model, output2, type = "class")
 
 length(svm.pred)
 
 
 
table(pred = svm.pred, true = output)
 

View(as.data.frame.matrix(table(prediction,output)))





nb = naiveBayes(Species ~ .,data = newdb$X)
prediction = predict(nb,output2)

nb

View(as.data.frame.matrix(table(prediction,output)))

dbDisconnect(con)