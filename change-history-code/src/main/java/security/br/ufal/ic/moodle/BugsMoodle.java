package security.br.ufal.ic.moodle;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

@Table(name = "BugsMoodle")
@Entity
public class BugsMoodle {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private int id;
	
	@Column(name = "bug")
	private String bug;
	
	@Column(name = "attach")
	private List<AttachmentsMoodle> attachs;
	
	private List<String> bugsLinks;
	
	public BugsMoodle(String bug){
		this.bug = bug;
		this.bugsLinks = new ArrayList<String>();
		this.attachs = new ArrayList<>();
		
	}
	
	public List<String> getBugsLinks() throws IOException{

		Connection connection = Jsoup.connect("https://tracker.moodle.org/sr/jira.issueviews:searchrequest-fullcontent/temp/SearchRequest.html?jqlQuery=project+%3D+MDL+AND+issuetype+%3D+Bug+AND+affectedVersion+%3D+3.0&tempMax=1000").timeout(3000000);
		Document doc = connection.get();
		Pattern pattern = Pattern.compile("((https.*tracker.*browse/MDL-[0-9]*))");
		Elements links = doc.select("a[href]");
        for(Element l: links){
            String link = l.attr("abs:href");    
            Matcher matcher = pattern.matcher(link);
            if(matcher.find()) {
            	String result = matcher.group();
            	if(checarLista(bugsLinks, result)){
            		bugsLinks.add(result);
                	System.out.println(result);
            	}
            }
        }
        
        return bugsLinks;
	}
	
	public boolean checarLista(List<String> al, String s){
		boolean b = true;
		
		for(int i = 0; i < al.size(); i++){
			if(al.get(i).equals(s)){
				b = false;
			}
		}
		
		return b;
	}
	public int getId() {
		return id;
	}
	public void setId(int id) {
		this.id = id;
	}
	public String getBug() {
		return bug;
	}
	public void setBug(String bug) {
		this.bug = bug;
	}
	public List<AttachmentsMoodle> getAttachs() {
		return attachs;
	}
	public void setAttachs(List<AttachmentsMoodle> attachs) {
		this.attachs = attachs;
	}
	public void setBugsLinks(List<String> bugsLinks) {
		this.bugsLinks = bugsLinks;
	}
	
	
	
}