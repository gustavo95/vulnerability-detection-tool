package security.br.ufal.ic.xen;

import java.util.ArrayList;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import security.br.ufal.ic.util.Utils;

public class XenLinesChangeApplication {

	public static void main(String[] args) {

		ProjectXenDAOCOntroller dao = new ProjectXenDAOCOntroller();
		final Pattern pattern = Pattern.compile("(commit)\\s*(.*)");

		for (XenDataNewApproach xennewappObj : dao.getListXenPatches()) {
			if (!xennewappObj.isAnalyzed()) {

				ArrayList<String> listCommits = new ArrayList<String>();
				String a = ColectCommitsXen.executarComando("git log --stat --all -- " + xennewappObj.getV_FILE());

				Matcher matcher = pattern.matcher(a);
				while (matcher.find()) {
					if (matcher.group(2).length() == 40) {
						listCommits.add(matcher.group(2));
					}
				}
				for (int i = listCommits.size() - 2; i > 0; i--) {
					XenSetLineChanges xenChangesIntance = null;

					if (listCommits.get(i).equals(xennewappObj.getCommit_fixed())) {
						break;
					}

					ArrayList<Set<String>> listChangesSetAdd = Utils.getSetLineNumerAdd(listCommits.get(i),
							xennewappObj.getV_FILE());

					ArrayList<Set<String>> listChangesSetRemoved = Utils.getSetLineNumerRemoved(listCommits.get(i),
							xennewappObj.getV_FILE());

					String setChagesAdd = String.join(",", listChangesSetAdd.get(0));
					String setChagesRemoved = String.join(",", listChangesSetRemoved.get(0));
					xenChangesIntance = new XenSetLineChanges();
					xenChangesIntance.setCommit(listCommits.get(i));
					xenChangesIntance.setFile(xennewappObj.getV_FILE());
					xenChangesIntance.setV_id(xennewappObj.getV_id());
					xenChangesIntance.setLines_Changed_add(setChagesAdd);
					xenChangesIntance.setLines_Changed_removed(setChagesRemoved);
					dao.addInstace(xenChangesIntance);

				}
			}
		}

	}

}
