package security.br.ufal.ic.temp;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.LinkedHashSet;
import java.util.Set;

public class Utils {

	public static String execueCommand(String comando) {

		Process process = null;
		try {
			process = Runtime.getRuntime().exec(comando);
		} catch (IOException e) {
			e.printStackTrace();
		}

		InputStream inputStream = process.getInputStream();

		String saida = "";

		{
			int n;

			try {
				while ((n = inputStream.read()) != -1) {
					saida += (char) n;
				}
			} catch (IOException e) {
				e.printStackTrace();
			}
		}

		return saida + "\n";
	}

	public static Set<String> getIntervalLinesChanged(String diff, String commit) {
		Set<String> intervalLines = new LinkedHashSet<>();
		String[] gitdiff = diff.split("\\n");
		int intLine = 0;
		int endline = 0;
		for (String line : gitdiff) {
			endline++;
			if (commit.contains("^")) {
				if (line.startsWith("+"))
					endline--;
			} else {
				if (line.startsWith("-"))
					endline--;
			}
			if (line.matches("@@.*@@.*|diff --git.*")) {
				
				if (line.contains("@@")) {
					if (intLine != 0)
						intervalLines.add((intLine + 3) + "-" + (endline - 5));
					if (commit.contains("^")) {
						line = line.replaceAll("@@", "").replaceAll(" ", "").split("[+]")[0].split(",")[0]
								.split("[-]")[1];
						intLine = Integer.parseInt(line);
						endline = intLine;
					} else {
						line = line.replaceAll("@@", "").replaceAll(" ", "").split("[+]")[1];
						line = line.split(",")[0];
						intLine = Integer.parseInt(line);
						endline = intLine;
					}
				} else if (line.contains("diff --git")) {
					if (intLine != 0)
						intervalLines.add((intLine + 3) + "-" + (endline - 4));
					endline = 0;
				}
			}
		}
		if (intLine != 0)
			intervalLines.add((intLine + 3) + "-" + (endline - 4));// +3 and -4
																	// for
																	// interval
																	// from git
		return intervalLines;
	}


	public static void main(String[] args) {
		
		
		String diff =Utils.execueCommand("git show 7ca56053b29633ef08b14e5ca16c663363edac36 -- arch/alpha/kernel/sys_takara.c");

		System.out.println(diff);
		for(int i=0;i<diff.split("(@@.*\\-)").length;i++){
			String diff2="@@ -"+diff.split("(@@.*\\-)")[i];

			
			System.out
			.println(Utils.getIntervalLinesChanged(diff2,
					"7ca56053b29633ef08b14e5ca16c663363edac36^"));
		
			//System.out.println(diff2);
			
		}
		
		
	
	

	}
}